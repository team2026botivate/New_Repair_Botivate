// src/pages/Forms/IndentForm.tsx
import { useState } from "react";
import { X, Upload, Plus } from "lucide-react";
import { Indent } from "../../models/types";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  onAddIndent: (indent: Indent) => void;
}

interface IndentFormData {
  machineName: string;
  machineSerialNo: string;
  doerName: string;
  department: string;
  machinePartName: string;
  problem: string;
  priority: string;
  expectedDeliveryDays: string;
  location: string;
  image: File | null;
}

const IndentForm = ({ isOpen, onClose, onAddIndent }: Props) => {
  const [formData, setFormData] = useState<IndentFormData>({
    machineName: "",
    machineSerialNo: "",
    doerName: "",
    department: "",
    machinePartName: "",
    problem: "",
    priority: "",
    expectedDeliveryDays: "",
    location: "",
    image: null,
  });

  // Dummy data options with Indian names
  const machineOptions = [
    "HP-102", "CB-201", "IO-103", "CNC-305", "IM-405", "LAT-507",
    "MILL-608", "GRIND-709", "DRILL-810", "PRESS-911"
  ];

  const serialNoOptions = [
    "HP-SN-2021-102", "CB-SN-2020-201", "IO-SN-2019-103", 
    "CNC-SN-2022-305", "IM-SN-2021-405", "LAT-SN-2020-507",
    "MILL-SN-2023-608", "GRIND-SN-2022-709", "DRILL-SN-2021-810", "PRESS-SN-2020-911"
  ];

  const doerOptions = [
    "Rajesh Kumar", "Priya Sharma", "Amit Patel", "Sunita Verma",
    "Vikram Singh", "Meera Reddy", "Anil Joshi", "Sneha Desai",
    "Rahul Mehta", "Pooja Yadav", "Arun Mishra", "Kavita Nair",
    "Sanjay Gupta", "Neha Choudhary", "Rohan Iyer", "Anjali Kapoor"
  ];

  const departmentOptions = [
    "Manufacturing", "Production", "Packaging", "Quality Control",
    "Maintenance", "Assembly", "Testing", "Research & Development"
  ];

  const priorityOptions = ["High", "Medium", "Low"];

  const machinePartOptions = [
    "Hydraulic Bearing", "Conveyor Belt", "Spindle Motor", "Tool Turret",
    "Coolant System", "Control Panel", "Gear Box", "Pneumatic Cylinder",
    "Sensors Array", "Drive Shaft", "Electrical Wiring", "Lubrication System"
  ];

  const locationOptions = [
    "Shop Floor A - Bay 3", "Assembly Line 2", "CNC Section - Bay 5",
    "Lathe Section", "Milling Area - Station 3", "Packaging Line 1",
    "Quality Lab", "Maintenance Bay", "Storage Area", "Testing Zone"
  ];

  const problemOptions = [
    "Unusual noise during operation",
    "Overheating after continuous operation",
    "Component stuck or jammed",
    "Leakage detected in system",
    "Electrical failure",
    "Performance degradation",
    "Calibration required",
    "Wear and tear replacement needed"
  ];

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setFormData((prev) => ({ ...prev, image: file }));
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    // Generate timestamp
    const now = new Date();
    const timestamp = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
    
    const newIndent: Indent = {
      id: Date.now(),
      timestamp: timestamp,
      indentNumber: "", // This will be generated by parent component
      machineName: formData.machineName,
      machineSerialNo: formData.machineSerialNo,
      doerName: formData.doerName,
      department: formData.department,
      machinePartName: formData.machinePartName,
      problem: formData.problem,
      priority: formData.priority,
      expectedDeliveryDays: parseInt(formData.expectedDeliveryDays) || 0,
      location: formData.location,
      taskStatus: "Pending",
      image: formData.image ? URL.createObjectURL(formData.image) : "/path/to/default.jpg",
      remarks: "Newly added indent",
      soundOfMachine: "Awaiting inspection",
      temperature: "N/A",
      maintenanceCost: 0,
    };

    onAddIndent(newIndent);
    resetForm();
    onClose();
  };

  const resetForm = () => {
    setFormData({
      machineName: "",
      machineSerialNo: "",
      doerName: "",
      department: "",
      machinePartName: "",
      problem: "",
      priority: "",
      expectedDeliveryDays: "",
      location: "",
      image: null,
    });
  };

  const addDummyData = () => {
    const randomMachine = machineOptions[Math.floor(Math.random() * machineOptions.length)];
    const randomSerial = serialNoOptions[Math.floor(Math.random() * serialNoOptions.length)];
    const randomDoer = doerOptions[Math.floor(Math.random() * doerOptions.length)];
    const randomDept = departmentOptions[Math.floor(Math.random() * departmentOptions.length)];
    const randomPriority = priorityOptions[Math.floor(Math.random() * priorityOptions.length)];
    const randomPart = machinePartOptions[Math.floor(Math.random() * machinePartOptions.length)];
    const randomProblem = problemOptions[Math.floor(Math.random() * problemOptions.length)];
    const randomLocation = locationOptions[Math.floor(Math.random() * locationOptions.length)];

    setFormData({
      machineName: randomMachine,
      machineSerialNo: randomSerial,
      doerName: randomDoer,
      department: randomDept,
      machinePartName: randomPart,
      problem: `${randomProblem} for ${randomMachine}`,
      priority: randomPriority,
      expectedDeliveryDays: (Math.floor(Math.random() * 10) + 1).toString(),
      location: randomLocation,
      image: null,
    });
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 overflow-y-auto">
      <div className="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        {/* Background overlay */}
        <div
          className="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75"
          onClick={onClose}
        ></div>

        {/* Modal panel */}
        <div className="inline-block w-full max-w-4xl my-8 overflow-hidden text-left align-middle transition-all transform bg-white rounded-lg shadow-xl">
          {/* Header */}
          <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-sky-600">
            <h3 className="text-lg font-semibold text-white">
              Add New Indent
            </h3>
            <button
              onClick={onClose}
              className="text-white hover:text-gray-200 transition-colors"
            >
              <X size={24} />
            </button>
          </div>

          {/* Form */}
          <form onSubmit={handleSubmit} className="px-6 py-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[70vh] overflow-y-auto pr-2">
              
              {/* Machine Name */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Machine Name <span className="text-red-500">*</span>
                </label>
                <div className="flex gap-2">
                  <select
                    name="machineName"
                    value={formData.machineName}
                    onChange={handleInputChange}
                    required
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent"
                  >
                    <option value="">Select Machine</option>
                    {machineOptions.map((machine, index) => (
                      <option key={index} value={machine}>{machine}</option>
                    ))}
                  </select>
                  <button
                    type="button"
                    onClick={() => setFormData(prev => ({...prev, machineName: machineOptions[Math.floor(Math.random() * machineOptions.length)]}))}
                    className="px-3 py-2 text-xs bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                  >
                    Fill
                  </button>
                </div>
              </div>

              {/* Machine Serial No */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Machine Serial No <span className="text-red-500">*</span>
                </label>
                <div className="flex gap-2">
                  <select
                    name="machineSerialNo"
                    value={formData.machineSerialNo}
                    onChange={handleInputChange}
                    required
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent"
                  >
                    <option value="">Select Serial No</option>
                    {serialNoOptions.map((serial, index) => (
                      <option key={index} value={serial}>{serial}</option>
                    ))}
                  </select>
                  <button
                    type="button"
                    onClick={() => setFormData(prev => ({...prev, machineSerialNo: serialNoOptions[Math.floor(Math.random() * serialNoOptions.length)]}))}
                    className="px-3 py-2 text-xs bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                  >
                    Fill
                  </button>
                </div>
              </div>

              {/* Doer Name */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Doer Name <span className="text-red-500">*</span>
                </label>
                <div className="flex gap-2">
                  <select
                    name="doerName"
                    value={formData.doerName}
                    onChange={handleInputChange}
                    required
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent"
                  >
                    <option value="">Select Doer</option>
                    {doerOptions.map((doer, index) => (
                      <option key={index} value={doer}>{doer}</option>
                    ))}
                  </select>
                  <button
                    type="button"
                    onClick={() => setFormData(prev => ({...prev, doerName: doerOptions[Math.floor(Math.random() * doerOptions.length)]}))}
                    className="px-3 py-2 text-xs bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                  >
                    Fill
                  </button>
                </div>
              </div>

              {/* Department */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Department <span className="text-red-500">*</span>
                </label>
                <div className="flex gap-2">
                  <select
                    name="department"
                    value={formData.department}
                    onChange={handleInputChange}
                    required
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent"
                  >
                    <option value="">Select Department</option>
                    {departmentOptions.map((dept, index) => (
                      <option key={index} value={dept}>{dept}</option>
                    ))}
                  </select>
                  <button
                    type="button"
                    onClick={() => setFormData(prev => ({...prev, department: departmentOptions[Math.floor(Math.random() * departmentOptions.length)]}))}
                    className="px-3 py-2 text-xs bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                  >
                    Fill
                  </button>
                </div>
              </div>

              {/* Machine Part Name */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Machine Part Name <span className="text-red-500">*</span>
                </label>
                <div className="flex gap-2">
                  <select
                    name="machinePartName"
                    value={formData.machinePartName}
                    onChange={handleInputChange}
                    required
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent"
                  >
                    <option value="">Select Part</option>
                    {machinePartOptions.map((part, index) => (
                      <option key={index} value={part}>{part}</option>
                    ))}
                  </select>
                  <button
                    type="button"
                    onClick={() => setFormData(prev => ({...prev, machinePartName: machinePartOptions[Math.floor(Math.random() * machinePartOptions.length)]}))}
                    className="px-3 py-2 text-xs bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                  >
                    Fill
                  </button>
                </div>
              </div>

              {/* Location */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Location <span className="text-red-500">*</span>
                </label>
                <div className="flex gap-2">
                  <select
                    name="location"
                    value={formData.location}
                    onChange={handleInputChange}
                    required
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent"
                  >
                    <option value="">Select Location</option>
                    {locationOptions.map((location, index) => (
                      <option key={index} value={location}>{location}</option>
                    ))}
                  </select>
                  <button
                    type="button"
                    onClick={() => setFormData(prev => ({...prev, location: locationOptions[Math.floor(Math.random() * locationOptions.length)]}))}
                    className="px-3 py-2 text-xs bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                  >
                    Fill
                  </button>
                </div>
              </div>

              {/* Problem */}
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Problem Description <span className="text-red-500">*</span>
                </label>
                <textarea
                  name="problem"
                  value={formData.problem}
                  onChange={handleInputChange}
                  required
                  rows={3}
                  placeholder="Describe the problem in detail..."
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent resize-none"
                />
              </div>

              {/* Priority */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Priority <span className="text-red-500">*</span>
                </label>
                <select
                  name="priority"
                  value={formData.priority}
                  onChange={handleInputChange}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent"
                >
                  <option value="">Select Priority</option>
                  {priorityOptions.map((priority, index) => (
                    <option key={index} value={priority}>{priority}</option>
                  ))}
                </select>
              </div>

              {/* Expected Delivery Days */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Expected Delivery Days <span className="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  name="expectedDeliveryDays"
                  value={formData.expectedDeliveryDays}
                  onChange={handleInputChange}
                  required
                  min="1"
                  placeholder="e.g., 3"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent"
                />
              </div>

              {/* Image Upload */}
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Upload Image
                </label>
                <div className="flex items-center justify-center w-full">
                  <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                      <Upload className="w-8 h-8 mb-2 text-gray-400" />
                      <p className="mb-2 text-sm text-gray-500">
                        <span className="font-semibold">Click to upload</span> or drag and drop
                      </p>
                      <p className="text-xs text-gray-500">PNG, JPG (MAX. 5MB)</p>
                      {formData.image && (
                        <p className="mt-2 text-sm text-sky-600 font-medium">
                          File selected: {formData.image.name}
                        </p>
                      )}
                    </div>
                    <input
                      type="file"
                      name="image"
                      accept="image/*"
                      onChange={handleFileChange}
                      className="hidden"
                    />
                  </label>
                </div>
              </div>
            </div>

            {/* Dummy Data Button */}
            <div className="mt-4 flex justify-between items-center">
              <button
                type="button"
                onClick={addDummyData}
                className="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-yellow-100 border border-yellow-300 rounded-lg hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-all"
              >
                <Plus size={16} className="mr-2" />
                Add Dummy Data
              </button>
            </div>

            {/* Form Actions */}
            <div className="flex gap-3 mt-6 pt-4 border-t border-gray-200">
              <button
                type="button"
                onClick={onClose}
                className="flex-1 px-4 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all"
              >
                Cancel
              </button>
              <button
                type="submit"
                className="flex-1 px-4 py-2.5 text-sm font-medium text-white bg-sky-600 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all"
              >
                Submit Indent
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

export default IndentForm;